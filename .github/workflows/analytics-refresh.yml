name: Analytics Refresh Assets

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: "What started this run (e.g. portal_button)"
        required: false
        type: string
      force_month:
        description: "Optional month override (YYYY-MM)"
        required: false
        type: string
  schedule:
    - cron: "17 3 * * *"

permissions:
  contents: write

concurrency:
  group: analytics-refresh-assets
  cancel-in-progress: false

jobs:
  refresh-assets:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect monthly input files
        id: detect_input
        run: |
          if [ ! -d "services/analytics/input" ]; then
            echo "services/analytics/input is missing."
            echo "has_input=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          count=$(find services/analytics/input -maxdepth 1 -type f -name '*.xlsx' | wc -l | tr -d ' ')
          echo "Detected .xlsx files: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_input=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_input=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute input signature
        id: input_signature
        if: steps.detect_input.outputs.has_input == 'true'
        run: |
          input_signature=$(find services/analytics/input -maxdepth 1 -type f -name '*.xlsx' -print0 | sort -z | xargs -0 sha256sum | sha256sum | cut -d' ' -f1)
          echo "input_signature=$input_signature" >> "$GITHUB_OUTPUT"

          previous_signature=$(python - <<'PY'
          import json
          from pathlib import Path

          path = Path('public/analytics/index.json')
          if not path.exists():
              print('')
          else:
              try:
                  payload = json.loads(path.read_text(encoding='utf-8'))
                  print(str(payload.get('input_signature') or '').strip())
              except Exception:
                  print('')
          PY
          )
          echo "previous_signature=$previous_signature" >> "$GITHUB_OUTPUT"

          changed=true
          if [ -n "$previous_signature" ] && [ "$previous_signature" = "$input_signature" ]; then
            changed=false
          fi

          skip_pipeline=false
          if [ "$changed" = "false" ] && [ "${{ github.event_name }}" = "schedule" ]; then
            skip_pipeline=true
          fi

          echo "changed=$changed" >> "$GITHUB_OUTPUT"
          echo "skip_pipeline=$skip_pipeline" >> "$GITHUB_OUTPUT"
          echo "Input signature: $input_signature"
          echo "Previous signature: $previous_signature"
          echo "Skip heavy pipeline: $skip_pipeline"

      - name: Setup Python
        if: steps.detect_input.outputs.has_input == 'true' && steps.input_signature.outputs.skip_pipeline != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install analytics dependencies
        if: steps.detect_input.outputs.has_input == 'true' && steps.input_signature.outputs.skip_pipeline != 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r services/analytics/requirements.txt

      - name: Run ingest + curated build
        if: steps.detect_input.outputs.has_input == 'true' && steps.input_signature.outputs.skip_pipeline != 'true'
        run: |
          python services/analytics/scripts/ingest_all_months.py \
            --input-dir services/analytics/input \
            --output-root services/analytics/data \
            --build-curated

      - name: Generate KPI reports for available months
        if: steps.detect_input.outputs.has_input == 'true' && steps.input_signature.outputs.skip_pipeline != 'true'
        env:
          FORCE_MONTH: ${{ inputs.force_month }}
        run: |
          if [ -n "$FORCE_MONTH" ]; then
            python services/analytics/scripts/generate_sales_kpis.py \
              --output-root services/analytics/data \
              --report-month "$FORCE_MONTH"
            exit 0
          fi

          months=$(find services/analytics/data/curated/sales_monthly/v1 -mindepth 1 -maxdepth 1 -type d -name 'report_month_*' -printf '%f\n' | sed 's/^report_month_//' | sort)
          if [ -z "$months" ]; then
            echo "No curated months found. Cannot generate KPI reports."
            exit 1
          fi

          for month in $months; do
            echo "Generating KPI for month: $month"
            python services/analytics/scripts/generate_sales_kpis.py \
              --output-root services/analytics/data \
              --report-month "$month"
          done

      - name: Sync generated KPIs to public analytics assets
        if: steps.detect_input.outputs.has_input == 'true' && steps.input_signature.outputs.skip_pipeline != 'true'
        env:
          INPUT_SIGNATURE: ${{ steps.input_signature.outputs.input_signature }}
        run: |
          python - <<'PY'
          from __future__ import annotations

          import json
          import os
          import shutil
          from datetime import datetime, timezone
          from pathlib import Path

          report_dir = Path("services/analytics/data/reports/sales_monthly/v1")
          public_dir = Path("public/analytics")
          public_dir.mkdir(parents=True, exist_ok=True)

          if not report_dir.exists():
            raise SystemExit("Missing report directory: services/analytics/data/reports/sales_monthly/v1")

          months: list[str] = []
          reports: dict[str, dict] = {}
          expected_files: set[str] = {"index.json"}

          for json_path in sorted(report_dir.glob("kpi_20??-??.json")):
            month = json_path.stem.replace("kpi_", "")
            html_path = report_dir / f"kpi_{month}_quicklook.html"
            if not html_path.exists():
              continue

            payload = json.loads(json_path.read_text(encoding="utf-8"))
            summary = payload.get("summary") if isinstance(payload.get("summary"), dict) else None

            target_json_name = json_path.name
            target_html_name = html_path.name
            shutil.copy2(json_path, public_dir / target_json_name)
            shutil.copy2(html_path, public_dir / target_html_name)

            expected_files.add(target_json_name)
            expected_files.add(target_html_name)

            reports[month] = {
              "report_month": month,
              "summary": summary,
              "json_path": f"/analytics/{target_json_name}",
              "quicklook_path": f"/analytics/{target_html_name}",
            }
            months.append(month)

          if not months:
            raise SystemExit("No KPI output files found after pipeline run.")

          for stale_path in sorted(public_dir.glob("kpi_20??-??*.json")):
            if stale_path.name not in expected_files:
              stale_path.unlink()
          for stale_path in sorted(public_dir.glob("kpi_20??-??*_quicklook.html")):
            if stale_path.name not in expected_files:
              stale_path.unlink()

          sorted_months = sorted(set(months))
          index_payload = {
            "generated_at_utc": datetime.now(timezone.utc).replace(microsecond=0).isoformat(),
            "input_signature": str(os.environ.get("INPUT_SIGNATURE", "")).strip(),
            "months": sorted_months,
            "reports": {month: reports[month] for month in sorted_months},
          }

          (public_dir / "index.json").write_text(
            json.dumps(index_payload, ensure_ascii=False, indent=2) + "\n",
            encoding="utf-8",
          )

          print(f"Synced KPI month files: {len(sorted_months)}")
          PY

      - name: Commit and push changes
        run: |
          if [ "${{ steps.detect_input.outputs.has_input }}" != "true" ]; then
            echo "No input files found in services/analytics/input. Nothing to refresh."
            exit 0
          fi

          if [ "${{ steps.input_signature.outputs.skip_pipeline }}" = "true" ]; then
            echo "Scheduled run skipped: input signature unchanged."
            exit 0
          fi

          if git diff --quiet -- public/analytics; then
            echo "No asset changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/analytics
          git commit -m "Refresh analytics assets (${GITHUB_RUN_ID})"
          git push
