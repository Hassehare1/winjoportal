name: Analytics Refresh Assets

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: "What started this run (e.g. portal_button)"
        required: false
        type: string
      force_month:
        description: "Optional month override (YYYY-MM)"
        required: false
        type: string
  schedule:
    - cron: "17 * * * *"

permissions:
  contents: write

concurrency:
  group: analytics-refresh-assets
  cancel-in-progress: false

jobs:
  refresh-assets:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install analytics dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r services/analytics/requirements.txt

      - name: Detect monthly input files
        id: detect_input
        run: |
          if [ ! -d "services/analytics/input" ]; then
            echo "services/analytics/input is missing."
            echo "has_input=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          count=$(find services/analytics/input -maxdepth 1 -type f -name '*.xlsx' | wc -l | tr -d ' ')
          echo "Detected .xlsx files: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_input=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_input=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run ingest + curated + KPI generation
        if: steps.detect_input.outputs.has_input == 'true'
        env:
          FORCE_MONTH: ${{ inputs.force_month }}
        run: |
          ARGS=(
            --input-dir services/analytics/input
            --output-root services/analytics/data
            --build-curated
            --generate-kpis
          )
          if [ -n "$FORCE_MONTH" ]; then
            ARGS+=(--kpi-report-month "$FORCE_MONTH")
          fi
          python services/analytics/scripts/ingest_all_months.py "${ARGS[@]}"

      - name: Sync generated KPIs to web assets
        if: steps.detect_input.outputs.has_input == 'true'
        run: |
          python - <<'PY'
          from pathlib import Path
          import shutil

          report_dir = Path("services/analytics/data/reports/sales_monthly/v1")
          assets_dir = Path("features/analytics/assets")
          assets_dir.mkdir(parents=True, exist_ok=True)

          synced = 0
          for json_path in sorted(report_dir.glob("kpi_20??-??.json")):
              month = json_path.stem.replace("kpi_", "")
              html_path = report_dir / f"kpi_{month}_quicklook.html"
              if not html_path.exists():
                  continue
              shutil.copy2(json_path, assets_dir / json_path.name)
              shutil.copy2(html_path, assets_dir / html_path.name)
              synced += 1

          print(f"Synced KPI month files: {synced}")
          PY

      - name: Commit and push changes
        run: |
          if [ "${{ steps.detect_input.outputs.has_input }}" != "true" ]; then
            echo "No input files found in services/analytics/input. Nothing to refresh."
            exit 0
          fi

          if git diff --quiet -- features/analytics/assets; then
            echo "No asset changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add features/analytics/assets
          git commit -m "Refresh analytics assets (${GITHUB_RUN_ID})"
          git push
